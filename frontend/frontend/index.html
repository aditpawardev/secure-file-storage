<!DOCTYPE html>
<html>
<head>
  <title>Secure File Storage</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>Login</h2>
<input id="username" placeholder="username" />
<input id="password" type="password" placeholder="password" />
<button onclick="login()">Login</button>

<hr />

<div id="app" style="display:none;">
  <h3>Upload File</h3>
  <input type="file" id="fileInput" />
  <button onclick="upload()">Upload</button>

  <h3>My Files</h3>
  <ul id="files"></ul>
</div>

<script>
const API = "http://192.168.0.122:8000";
let token = "";

async function login() {
  const u = document.getElementById("username").value;
  const p = document.getElementById("password").value;

  const res = await fetch(API + "/api/auth/login/", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({username: u, password: p})
  });

  const data = await res.json();
  token = data.access;

  if (!token) {
    alert("LOGIN FAILED");
    return;
  }

  document.getElementById("app").style.display = "block";
  loadFiles();
}

async function loadFiles() {
  const res = await fetch(API + "/api/files/", {
    headers: {"Authorization": "Bearer " + token}
  });

  const files = await res.json();
  const ul = document.getElementById("files");
  ul.innerHTML = "";

  if (files.length === 0) {
    ul.innerHTML = "<li>No files</li>";
    return;
  }

  files.forEach(f => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${f.original_name}
      <button onclick="download(${f.id})">Download</button>
      <button onclick="removeFile(${f.id})">Delete</button>
    `;
    ul.appendChild(li);
  });
}

async function upload() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return;

  const fd = new FormData();
  fd.append("file", file);

  await fetch(API + "/api/files/upload/", {
    method: "POST",
    headers: {"Authorization": "Bearer " + token},
    body: fd
  });

  loadFiles();
}

async function download(id) {
  const res = await fetch(API + "/api/files/" + id + "/download/", {
    headers: {"Authorization": "Bearer " + token}
  });

  const blob = await res.blob();
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "file";
  a.click();
}

async function removeFile(id) {
  await fetch(API + "/api/files/" + id + "/", {
    method: "DELETE",
    headers: {"Authorization": "Bearer " + token}
  });

  loadFiles();
}
</script>

</body>
</html>
